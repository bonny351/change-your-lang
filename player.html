<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<meta name="viewport"
content="width=device-width, height=device-height,
initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Now Playing</title>

<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  background:#040f14;
  font-family:"Segoe UI",system-ui,sans-serif;
  color:white;
  overflow:hidden;
}

/* BACKGROUND */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(circle at top, rgba(0,255,200,.25), transparent 55%),
    radial-gradient(circle at bottom, rgba(0,140,255,.35), transparent 60%),
    linear-gradient(#020b14,#061b25);
}

/* WAVES */
#waves{
  position:fixed;
  inset:0;
  pointer-events:none;
}

/* APP */
#app{
  position:relative;
  z-index:2;
  height:100svh;
  padding:clamp(12px,4vw,40px);
  display:flex;
  flex-direction:column;
  box-sizing:border-box;
}

/* HEADER */
#header{
  display:flex;
  align-items:center;
  gap:clamp(12px,4vw,25px);
}
#avatar{
  width:clamp(60px,12vw,90px);
  height:clamp(60px,12vw,90px);
  border-radius:50%;
  background:radial-gradient(circle,#3cffb4,#0a4f3a);
  box-shadow:0 0 35px #3cffb4;
}
#profileName{
  font-size:clamp(22px,5vw,36px);
  font-weight:600;
}

/* NOW PLAYING */
#nowPlaying{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:clamp(16px,4vw,35px);
  margin-top:clamp(10px,3vw,25px);
}

#cover{
  width:clamp(100px,22vw,160px);
  height:clamp(100px,22vw,160px);
  border-radius:12px;
  background:linear-gradient(135deg,#ffaa55,#553300);
  box-shadow:0 0 30px rgba(255,170,85,.5);
}

#songTitle{
  font-size:clamp(22px,5vw,32px);
  margin:0;
}

/* PROGRESS */
#progress{
  width:min(100%,420px);
  margin-top:12px;
}

/* CONTROLS */
#controls{
  display:flex;
  gap:clamp(16px,4vw,25px);
  margin-top:12px;
}
.ctrl{
  width:clamp(56px,12vw,70px);
  height:clamp(56px,12vw,70px);
  border-radius:50%;
  background:radial-gradient(circle,#3cffb4,#0a4f3a);
  box-shadow:0 0 35px #3cffb4;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:clamp(24px,6vw,30px);
  cursor:pointer;
}

/* PLAYLISTS */
#lists{
  display:grid;
  grid-template-columns:1fr;
  gap:clamp(12px,3vw,30px);
  margin-top:clamp(16px,4vw,35px);
}
@media (min-width:900px){
  #lists{ grid-template-columns:1fr 1fr; }
}

.panel{
  background:rgba(0,0,0,.35);
  border-radius:16px;
  padding:20px;
}
.song{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.1);
  cursor:pointer;
}
.song:hover{ background:rgba(255,255,255,.08); }

/* FOOTER */
#footer{
  position:fixed;
  bottom:clamp(12px,3vw,24px);
  left:clamp(12px,3vw,24px);
  z-index:10;
}
.footerBtn{
  padding:14px 26px;
  border-radius:20px;
  background:rgba(0,255,200,.18);
  box-shadow:0 0 25px rgba(0,255,200,.4);
  cursor:pointer;
}
</style>
</head>

<body>

<canvas id="waves"></canvas>

<div id="app">

  <div id="header">
    <div id="avatar"></div>
    <div id="profileName"></div>
  </div>

  <div id="nowPlaying">
    <div id="cover"></div>
    <div>
      <h2 id="songTitle">Select a song</h2>
      <input id="progress" type="range" min="0" max="100" value="0">
      <div id="controls">
        <div class="ctrl">⏮</div>
        <div class="ctrl">▶</div>
        <div class="ctrl">⏭</div>
      </div>
    </div>
  </div>

  <div id="lists">
    <div class="panel" id="playlist"></div>
    <div class="panel">
      <p style="opacity:.7">
        • Add songs from USB / SD / storage<br>
        • Long-press to remove<br>
        • Guest wipes after 7 hours
      </p>
    </div>
  </div>

</div>

<div id="footer">
  <div class="footerBtn" onclick="location.href='index.html'">
    ← Back to Profiles
  </div>
</div>

<input id="filePick" type="file" accept=".mp3" multiple hidden>

<script>
/* ================= PROFILE ================= */
const params = new URLSearchParams(location.search);
const profile = params.get("profile") || "Guest";
profileName.textContent = "Now Playing for " + profile;

/* ================= GUEST TIMEOUT ================= */
const GUEST_TIMEOUT = 7 * 60 * 60 * 1000;
const now = Date.now();
const KEY = "playlist_" + profile;

if(profile === "Guest"){
  const last = localStorage.getItem("guest_last");
  if(!last || now - last > GUEST_TIMEOUT){
    localStorage.removeItem(KEY);
  }
  localStorage.setItem("guest_last", now);
}

/* ================= AUDIO ================= */
const audio = new Audio();

/* ---- AUDIO UNLOCK (CRITICAL) ---- */
const AudioContextClass = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContextClass();
const source = audioCtx.createMediaElementSource(audio);
source.connect(audioCtx.destination);

function unlockAudio(){
  if(audioCtx.state !== "running"){
    audioCtx.resume();
  }
  document.removeEventListener("pointerdown", unlockAudio);
  document.removeEventListener("keydown", unlockAudio);
}
document.addEventListener("pointerdown", unlockAudio);
document.addEventListener("keydown", unlockAudio);

let current = 0;
let playlist = JSON.parse(localStorage.getItem(KEY)) || [];

/* ================= SAVE ================= */
function save(){
  localStorage.setItem(KEY, JSON.stringify(playlist));
  if(profile === "Guest") localStorage.setItem("guest_last", Date.now());
}

/* ================= RENDER ================= */
const playlistDiv = document.getElementById("playlist");
function render(){
  playlistDiv.innerHTML = `<h3>${profile}’s Playlist</h3>`;
  playlist.forEach((s,i)=>{
    const d = document.createElement("div");
    d.className = "song";
    d.textContent = s.name;
    d.onclick = () => play(i);
    d.oncontextmenu = e=>{
      e.preventDefault();
      if(confirm("Remove song?")){
        playlist.splice(i,1);
        save(); render();
      }
    };
    playlistDiv.appendChild(d);
  });
  const add = document.createElement("div");
  add.className = "song";
  add.textContent = "➕ Add from USB / Storage";
  add.onclick = ()=>filePick.click();
  playlistDiv.appendChild(add);
}

/* ================= FILE PICK ================= */
filePick.onchange = ()=>{
  [...filePick.files].forEach(f=>{
    playlist.push({
      name: f.name.replace(".mp3",""),
      src: URL.createObjectURL(f)
    });
  });
  save(); render();
};

/* ================= PLAYBACK ================= */
function play(i){
  current = i;
  audio.src = playlist[i].src;
  audio.play();
  songTitle.textContent = playlist[i].name;
  if(audioCtx.state !== "running") audioCtx.resume();
}

const ctrls = document.querySelectorAll(".ctrl");
ctrls[0].onclick = ()=>play((current-1+playlist.length)%playlist.length);
ctrls[1].onclick = ()=>audio.paused ? audio.play() : audio.pause();
ctrls[2].onclick = ()=>play((current+1)%playlist.length);

audio.ontimeupdate = ()=>{
  if(audio.duration){
    progress.value = (audio.currentTime / audio.duration) * 100;
  }
};
progress.oninput = ()=>{
  if(audio.duration){
    audio.currentTime = (progress.value / 100) * audio.duration;
  }
};

/* ================= INIT ================= */
render();

/* ================= WAVES ================= */
const c = waves;
const ctx = c.getContext("2d");
function resize(){ c.width=innerWidth; c.height=innerHeight }
resize(); addEventListener("resize", resize);

let t=0;
(function draw(){
  ctx.clearRect(0,0,c.width,c.height);
  for(let i=0;i<3;i++){
    ctx.beginPath();
    for(let x=0;x<=c.width;x+=6){
      ctx.lineTo(x, c.height*.82 + Math.sin(x/160+t+i)*25);
    }
    ctx.strokeStyle = `rgba(0,255,200,${0.25-i*.06})`;
    ctx.lineWidth = 3;
    ctx.shadowBlur = 20;
    ctx.shadowColor = "#3cffb4";
    ctx.stroke();
  }
  t += .02;
  requestAnimationFrame(draw);
})();
</script>

</body>
</html>
